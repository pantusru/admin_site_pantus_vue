let data =
    [
        [{"id":391,"parentId":null,"name":"Трансмиссия","code":"transmissiya","level":1,"children":[{"id":392,"parentId":391,"name":"Валы карданные","code":"valy_kardannye","level":2,"children":[]},{"id":476,"parentId":391,"name":"Шрус","code":"shrus","level":2,"children":[{"id":477,"parentId":476,"name":"Шрус наружний","code":"shrus_naruzhnij","level":3,"children":[{"id":478,"parentId":477,"name":"Кожух защитный","code":"kozhuh_zashchitnyj","level":4,"children":[]}]}]},{"id":510,"parentId":391,"name":"Сцепление","code":"sceplenie","level":2,"children":[{"id":455,"parentId":510,"name":"Цилиндры сцепления","code":"cilindry_scepleniya","level":3,"children":[]},{"id":3123,"parentId":510,"name":"Подшипники сцепления выжимные","code":"podshipniki_stsepleniya_vyzhimnye","level":3,"children":[]},{"id":3124,"parentId":510,"name":"Пружины","code":"pruzhiny","level":3,"children":[]}]},{"id":3044,"parentId":391,"name":"Вилки сцепления","code":"vilki_scepleniya","level":2,"children":[]},{"id":3045,"parentId":391,"name":"Диски сцепления","code":"diski_scepleniya","level":2,"children":[]},{"id":3046,"parentId":391,"name":"Комплекты сцепления","code":"komplekty_scepleniya","level":2,"children":[]},{"id":3047,"parentId":391,"name":"Корзины сцепления","code":"korziny_scepleniya","level":2,"children":[{"id":3082,"parentId":3047,"name":"Петли корзин сцепления","code":"petli_korzin_stsepleniya","level":3,"children":[]}]},{"id":3048,"parentId":391,"name":"Муфты выжимные","code":"mufty_vyzhimnye","level":2,"children":[]},{"id":3049,"parentId":391,"name":"Тросы сцепления","code":"trosy_scepleniya","level":2,"children":[]},{"id":3051,"parentId":391,"name":"Штоки КПП","code":"shtoki_kpp","level":2,"children":[]},{"id":3080,"parentId":391,"name":"Прокладки картера КПП","code":"prokladki_kartera_kpp","level":2,"children":[]},{"id":3131,"parentId":391,"name":"Шланги трансмиссии","code":"shlangi_transmissii","level":2,"children":[]},{"id":3143,"parentId":391,"name":"Маховики","code":"makhoviki","level":2,"children":[]},{"id":5095,"parentId":391,"name":"Подшипники КПП","code":"podshipniki_kpp","level":2,"children":[]},{"id":5177,"parentId":391,"name":"Мост задний","code":"most zadnij","level":2,"children":[]}]},{"id":510,"parentId":391,"name":"Сцепление","code":"sceplenie","level":2,"children":[{"id":455,"parentId":510,"name":"Цилиндры сцепления","code":"cilindry_scepleniya","level":3,"children":[]},{"id":3123,"parentId":510,"name":"Подшипники сцепления выжимные","code":"podshipniki_stsepleniya_vyzhimnye","level":3,"children":[]},{"id":3124,"parentId":510,"name":"Пружины","code":"pruzhiny","level":3,"children":[]}]},{"id":477,"parentId":476,"name":"Шрус наружний","code":"shrus_naruzhnij","level":3,"children":[{"id":478,"parentId":477,"name":"Кожух защитный","code":"kozhuh_zashchitnyj","level":4,"children":[]}]},{"id":455,"parentId":510,"name":"Цилиндры сцепления","code":"cilindry_scepleniya","level":3,"children":[]}],
        [{"id":391,"parentId":null,"name":"Трансмиссия","code":"transmissiya","level":1,"children":[{"id":392,"parentId":391,"name":"Валы карданные","code":"valy_kardannye","level":2,"children":[]},{"id":476,"parentId":391,"name":"Шрус","code":"shrus","level":2,"children":[{"id":477,"parentId":476,"name":"Шрус наружний","code":"shrus_naruzhnij","level":3,"children":[{"id":478,"parentId":477,"name":"Кожух защитный","code":"kozhuh_zashchitnyj","level":4,"children":[]}]}]},{"id":510,"parentId":391,"name":"Сцепление","code":"sceplenie","level":2,"children":[{"id":455,"parentId":510,"name":"Цилиндры сцепления","code":"cilindry_scepleniya","level":3,"children":[]},{"id":3123,"parentId":510,"name":"Подшипники сцепления выжимные","code":"podshipniki_stsepleniya_vyzhimnye","level":3,"children":[]},{"id":3124,"parentId":510,"name":"Пружины","code":"pruzhiny","level":3,"children":[]}]},{"id":3044,"parentId":391,"name":"Вилки сцепления","code":"vilki_scepleniya","level":2,"children":[]},{"id":3045,"parentId":391,"name":"Диски сцепления","code":"diski_scepleniya","level":2,"children":[]},{"id":3046,"parentId":391,"name":"Комплекты сцепления","code":"komplekty_scepleniya","level":2,"children":[]},{"id":3047,"parentId":391,"name":"Корзины сцепления","code":"korziny_scepleniya","level":2,"children":[{"id":3082,"parentId":3047,"name":"Петли корзин сцепления","code":"petli_korzin_stsepleniya","level":3,"children":[]}]},{"id":3048,"parentId":391,"name":"Муфты выжимные","code":"mufty_vyzhimnye","level":2,"children":[]},{"id":3049,"parentId":391,"name":"Тросы сцепления","code":"trosy_scepleniya","level":2,"children":[]},{"id":3051,"parentId":391,"name":"Штоки КПП","code":"shtoki_kpp","level":2,"children":[]},{"id":3080,"parentId":391,"name":"Прокладки картера КПП","code":"prokladki_kartera_kpp","level":2,"children":[]},{"id":3131,"parentId":391,"name":"Шланги трансмиссии","code":"shlangi_transmissii","level":2,"children":[]},{"id":3143,"parentId":391,"name":"Маховики","code":"makhoviki","level":2,"children":[]},{"id":5095,"parentId":391,"name":"Подшипники КПП","code":"podshipniki_kpp","level":2,"children":[]},{"id":5177,"parentId":391,"name":"Мост задний","code":"most zadnij","level":2,"children":[]}]},{"id":510,"parentId":391,"name":"Сцепление","code":"sceplenie","level":2,"children":[{"id":455,"parentId":510,"name":"Цилиндры сцепления","code":"cilindry_scepleniya","level":3,"children":[]},{"id":3123,"parentId":510,"name":"Подшипники сцепления выжимные","code":"podshipniki_stsepleniya_vyzhimnye","level":3,"children":[]},{"id":3124,"parentId":510,"name":"Пружины","code":"pruzhiny","level":3,"children":[]}]},{"id":477,"parentId":476,"name":"Шрус наружний","code":"shrus_naruzhnij","level":3,"children":[{"id":478,"parentId":477,"name":"Кожух защитный","code":"kozhuh_zashchitnyj","level":4,"children":[]}]},{"id":3123,"parentId":510,"name":"Подшипники сцепления выжимные","code":"podshipniki_stsepleniya_vyzhimnye","level":3,"children":[]}],
        [{"id":2960,"parentId":null,"name":"Система впуска","code":"sistema_vpuska","level":1,"children":[{"id":323,"parentId":2960,"name":"Впускная система","code":"vpusknaya_sistema","level":2,"children":[{"id":324,"parentId":323,"name":"Патрубки воздушного фильтра","code":"patrubki_vozdushnogo_filtra","level":3,"children":[]}]},{"id":2961,"parentId":2960,"name":"Карбюраторы","code":"karbyuratory","level":2,"children":[]},{"id":2962,"parentId":2960,"name":"Кольца уплотнительные форсунки","code":"kolca_uplotnitelnye_forsunki","level":2,"children":[]},{"id":2963,"parentId":2960,"name":"Прокладки впускного коллектора","code":"prokladki_vpusknogo_kollektora","level":2,"children":[]},{"id":3077,"parentId":2960,"name":"Впускные коллекторы","code":"vpusknye_kollektory","level":2,"children":[]}]},{"id":323,"parentId":2960,"name":"Впускная система","code":"vpusknaya_sistema","level":2,"children":[{"id":324,"parentId":323,"name":"Патрубки воздушного фильтра","code":"patrubki_vozdushnogo_filtra","level":3,"children":[]}]},{"id":2962,"parentId":2960,"name":"Кольца уплотнительные форсунки","code":"kolca_uplotnitelnye_forsunki","level":2,"children":[]}]
    ]



class TreeConverter {
    constructor(data) {
        this.data = data;
    }

    createNode(item, parentId) {
            //console.log(id)
        parentId = parentId ? parentId.id : null

        return {
            id: item.id,
            parentId,
            name: item.name,
            code: item.code,
            level: item.level,
            children: []
        };
    }

    isExistInFlatNodes(flatNodes, node) {
        return !!flatNodes[node.id];
    }
    // { id: 10, parentId: undefined, children: [] }
    getFlatNodes() {
        const flatNodes = {};
        this.data.forEach(line => {
           // console.log(line)
            line.forEach((el, i) => {

                const newNode = this.createNode(el, line[i - 1]);
              //  console.log(newNode)
                if (!this.isExistInFlatNodes(flatNodes, newNode)) {
                    flatNodes[newNode.id] = newNode;
                }
            });
        });
      //  console.log(flatNodes)
        return flatNodes;
    }

    getTreeFromFlatNodes(flatNodes) {
        const tree = [];
        const nodes = Object.values(flatNodes);
        nodes.forEach(node => {
            if (node.parentId === null) {
                tree.push(node);
            } else {
                const parentNode = flatNodes[node.parentId];
                parentNode.children.push(node);
            }
        });
        return tree;
    }

    getTree() {
        const flatNodes = this.getFlatNodes();
        return this.getTreeFromFlatNodes(flatNodes);
    }
}
const converter = new TreeConverter(data);
console.log(...converter.getTree())
